#     _____ __    _____
#    |     |  |  |_   _|  C++ Object Libraries for IBM i
#    |  |  |  |__ _| |_   File:   BUILD/makefile.txt
#    |_____|_____|_____|  Author: Sergey Chebotarev
#     





#***** ОПЦИИ КОМПИЛЯЦИИ И СБОРКИ ***************************************************************************************
!if $(debug) == 0
tmplib   = QTEMP
optimize = DBGVIEW(*NONE) OPTIMIZE(40) INLINE(*ON) 
define   = DEFINE('__IBMCPP_TR1__=1' 'NDEBUG')

!else
tmplib   = $(dstlib)
optimize = DBGVIEW(*ALL) OPTIMIZE(20)
define   = DEFINE('__IBMCPP_TR1__=1' 'DEBUG')
!endif

options  = LANGLVL(*EXTENDED0X) PFROPT(*STRDONLY) OPTION(*SHOWUSR) +
           CHECKOUT(*CLASS *COND *EFFECT *GENERAL *GOTO *LANG *PARM *REACH *TRUNC *UNUSED)
linker   = BNDSRVPGM(QYPPRT370 QYPPSL510)





#***** ПОЛНАЯ СБОРКА ***************************************************************************************************
all: $(dstlib)/OLITEST<PGM>

$(dstlib)/OLITEST<PGM>: $(tmplib)/MAIN<MODULE> $(tmplib)/FMT<MODULE> $(tmplib)/STL<MODULE> $(tmplib)/STRING<MODULE> +
                        $(tmplib)/OBJECT<MODULE> +
                        $(dstlib)/GOOGLE\$<MODULE> $(dstlib)/FMT\$<MODULE> $(dstlib)/OBJECT\$<MODULE>
   -DLTBNDDIR  BNDDIR($(dstlib)/OLI)
    CRTBNDDIR  BNDDIR($(dstlib)/OLI)
    ADDBNDDIRE BNDDIR($(dstlib)/OLI) +
               OBJ(($(dstlib)/GOOGLE\$ *MODULE) ($(dstlib)/FMT\$ *MODULE) ($(dstlib)/OBJECT\$ *MODULE))
   -DLTPGM     PGM($(@L)/$(@F))
    CRTPGM     PGM($(@L)/$(@F)) +
               MODULE($(tmplib)/MAIN $(tmplib)/FMT $(tmplib)/STL $(tmplib)/STRING $(tmplib)/OBJECT) +
               BNDDIR($(dstlib)/OLI) +
               $(linker)





#***** ПОЛНАЯ ОЧИСТКА **************************************************************************************************
clean:
   -DLTPGM     PGM($(dstlib)/OLITEST)
   -DLTBNDDIR  BNDDIR($(dstlib)/OLI)
   -DLTMOD     MODULE($(dstlib)/GOOGLE\$)
   -DLTMOD     MODULE($(dstlib)/FMT\$)
   -DLTMOD     MODULE($(dstlib)/OBJECT\$)
   -DLTMOD     MODULE($(tmplib)/MAIN)
   -DLTMOD     MODULE($(tmplib)/FMT)
   -DLTMOD     MODULE($(tmplib)/STL)
   -DLTMOD     MODULE($(tmplib)/STRING)
   -DLTMOD     MODULE($(tmplib)/OBJECT)





#***** ОПИСАНИЕ ЗАВИСИМОСТЕЙ ЗАГОЛОВОЧНЫХ ФАЙЛОВ ***********************************************************************
google_gtest  = $(srclib)/GTEST.GOOGLE
icore_define  = $(srclib)/DEFINE.ICORE
stl_define    = $(srclib)/DEFINE.STL
object_define = $(srclib)/DEFINE.OBJECT

stl_typetrait = $(srclib)/TYPE_TRAIT.STL $(stl_define)
stl_iterator  = $(srclib)/ITERATOR.STL   $(stl_define)
stl_cstddef   = $(srclib)/CSTDDEF.STL    $(stl_define)
icore_string  = $(srclib)/STRING.ICORE   $(icore_define) $(stl_typetrait) $(stl_iterator) $(stl_cstddef)
object_fs     = $(srclib)/FS.OBJECT      $(object_define) $(icore_string)





#***** СБОРКА МОДУЛЕЙ БИБЛИОТЕКИ ***************************************************************************************
$(dstlib)/GOOGLE\$<MODULE>: $(srclib)/GTEST.GOOGLE $(srclib)/GMOCK.GOOGLE $(srclib)/GOOGLE\$.GOOGLE
   -DLTMOD     MODULE($(@L)/$(@F))
    CRTCPPMOD  MODULE($(@L)/$(@F)) SRCFILE($(srclib)/GOOGLE) SRCMBR($(@F)) +
               $(optimize) $(define) $(options)

$(dstlib)/FMT\$<MODULE>: $(srclib)/FORMAT\$.FMT $(srclib)/FORMAT.FMT
   -DLTMOD     MODULE($(@L)/$(@F))
    CRTCPPMOD  MODULE($(@L)/$(@F)) SRCFILE($(srclib)/FMT) SRCMBR(FORMAT\$) +
               $(optimize) $(define) $(options)

$(dstlib)/OBJECT\$<MODULE>: $(srclib)/OBJECT\$.OBJECT $(object_fs) $(google_gtest)
   -DLTMOD     MODULE($(@L)/$(@F))
    CRTCPPMOD  MODULE($(@L)/$(@F)) SRCFILE($(srclib)/OBJECT) SRCMBR($(@F)) +
               $(optimize) $(define) $(options)





#***** ОПИСАНИЕ ЗАВИСИМОСТЕЙ МОДУЛЕЙ ЮНИТ-ТЕСТОВ ***********************************************************************
$(tmplib)/MAIN<MODULE>: +
    $(srclib)/MAIN.TEST $(srclib)/GTEST.GOOGLE

$(tmplib)/FMT<MODULE>: +
    $(srclib)/FMT.TEST $(srclib)/FORMAT.FMT $(srclib)/GTEST.GOOGLE

$(tmplib)/STL<MODULE>: +
    $(srclib)/STL.TEST $(srclib)/TYPE_TRAIT.STL $(srclib)/UTILITY.STL $(srclib)/MEMORY.STL +
    $(srclib)/MAP.STL $(srclib)/ITERATOR.STL +
    $(srclib)/DEFINE.STL

$(tmplib)/STRING<MODULE>: $(srclib)/STRING.TEST $(icore_string) $(google_gtest)

$(tmplib)/OBJECT<MODULE>: $(srclib)/OBJECT.TEST $(object_fs) $(google_gtest)




#***** ПРАВИЛО КОМПИЛЯЦИИ МОДУЛЕЙ ЮНИТ-ТЕСТОВ **************************************************************************
$(tmplib)/MAIN<MODULE> $(tmplib)/FMT<MODULE> $(tmplib)/STL<MODULE> $(tmplib)/STRING<MODULE> $(tmplib)/OBJECT<MODULE>:
   -DLTMOD     MODULE($(@L)/$(@F))
    CRTCPPMOD  MODULE($(@L)/$(@F)) SRCFILE($(srclib)/TEST) SRCMBR($(@F)) +
               $(optimize) $(define) $(options)
